FROM docker.io/rockylinux/rockylinux:10 AS base


RUN echo "**** Update System ****"
RUN dnf -y update

RUN dnf -y install epel-release
RUN dnf -y config-manager --set-enabled crb
RUN dnf -y update

RUN echo "**** Install System Packages ****"
RUN dnf -y groupinstall "Development Tools"
RUN dnf -y install        \
        gcc-c++           \
        openmpi-devel     

RUN dnf -y install        \
        blas-devel        \
        lapack-devel

RUN dnf -y install        \
        python3           \
        python-devel

RUN dnf -y install        \
        curl              \
        cmake             \
        git               \
        mold              \
        ninja-build       \
        texinfo           

RUN dnf -y install        \
        boost-devel       \
        gmp-devel         \
        mpfr-devel        \
        zlib-devel

RUN dnf -y install        \
        vim               \
        neovim            \
        tmux


RUN echo "**** cleanup ****" && \
    dnf autoremove -y &&        \
    dnf clean all &&            \
    rm -rf                      \
       /config/.cache           \
       /tmp/*


FROM base AS dcs2

RUN echo "**** Create the default user ****"
RUN useradd -m -s /bin/bash dealii

WORKDIR /home/dealii
USER dealii

COPY data/bashrc-pre /home/dealii/.bashrc


RUN echo "**** Install deal.II ****"
RUN git clone https://github.com/kinnewig/dcs2.git dcs2-source

WORKDIR /home/dealii/dcs2-source
RUN git fetch --all
RUN git checkout cbc251f6e15ee4319f2a02d238f938e33db263d5
RUN source /home/dealii/.bashrc && \
    /bin/bash dcs2.sh -b /home/dealii/dcs2-build -p /home/dealii/dcs2 -j 12 --cmake-flags "-D TRILINOS_CUSTOM_URL=https://github.com/kinnewig/Trilinos.git -D TRILINOS_CUSTOM_TAG=OptimizedSchwarz-16.1.0 -D DEALII_CUSTOM_URL=https://github.com/kinnewig/dealii.git -D DEALII_CUSTOM_TAG=FROSch-preconditioner-latest -D TPL_ENABLE_BLIS=OFF -D TPL_ENABLE_LIBFLAME=OFF" -U

COPY data/bashrc-post /home/dealii/.bashrc

RUN echo "**** cleanup ****" && \
    rm -rf                      \
       /home/dealii/dcs2-source \
       /home/dealii/dcs2-build


WORKDIR /home/dealii
ENTRYPOINT ["/bin/bash"]
